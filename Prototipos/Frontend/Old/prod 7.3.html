<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CatalogAI - Gest√£o de Produtos v7.3 (Abas e Exemplos Corrigidos)</title>
    <style>
        :root {
            --sidebar-bg: #1f2a40; --sidebar-text: #cfd8e5; --main-bg: #f4f6f8;
            --card-bg: #fff; --primary: #3b82f6; --success: #10b981;
            --info: #6366f1; --warning: #f59e0b; --danger: #ef4444;
            --font: 'Helvetica Neue', Arial, sans-serif; --radius: 8px;
            --shadow-sm: 0 1px 4px rgba(0,0,0,0.1); --shadow-md: 0 4px 8px rgba(0,0,0,0.15);
            --border-color: #e5e7eb; --text-color-light: #6b7280; --disabled-bg: #e9ecef;
        }
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { display: flex; height: 100vh; font-family: var(--font); background: var(--main-bg); overflow: hidden; }
        .sidebar { width: 240px; background: var(--sidebar-bg); color: var(--sidebar-text); padding: 1rem; display: flex; flex-direction: column; height: 100%; flex-shrink: 0; }
        .sidebar .logo { font-size: 1.75rem; font-weight: bold; color: #fff; margin-bottom: 2rem; text-align: center; }
        .sidebar nav { flex: 1; }
        .sidebar nav a { display: block; padding: 0.75rem 1rem; color: var(--sidebar-text); text-decoration: none; border-radius: var(--radius); margin-bottom: 0.5rem; cursor: pointer; transition: background-color 0.2s, color 0.2s; }
        .sidebar nav a.active, .sidebar nav a:hover { background: #16203a; color: #fff; }
        .main { flex: 1; display: flex; flex-direction: column; height: 100%; overflow: hidden; }
        .topbar { background: var(--card-bg); padding: 1rem 2rem; box-shadow: var(--shadow-sm); display: flex; align-items: center; justify-content: space-between; min-height: 60px; flex-shrink: 0; }
        .topbar h1 { font-size: 1.65rem; color: #333; margin: 0; }
        .content { flex: 1; padding: 1.5rem 2rem; overflow-y: auto; }
        .hidden { display: none !important; }
        .card { background: var(--card-bg); border-radius: 18px; box-shadow: 0 2px 12px 0 rgba(60,100,150,0.11); padding: 1.5rem 2.1rem; margin-bottom: 1rem; }
        .card-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem; padding-bottom: 1rem; border-bottom: 1px solid var(--border-color); }
        .card-header h3 { font-size: 1.25rem; margin: 0; }
        
        button, .btn { border-radius: var(--radius); border: 1px solid transparent; padding: 0.6em 1.2em; font-size: 0.9em; font-weight: 500; font-family: inherit; background-color: var(--primary); color: white; cursor: pointer; transition: background-color 0.2s, filter 0.2s, opacity 0.2s; display: inline-flex; align-items:center; justify-content:center; gap: 0.3em;}
        button .spinner { width: 1em; height: 1em; border: 2px solid rgba(255,255,255,0.3); border-top-color: white; border-radius: 50%; animation: spin 1s linear infinite; margin-right: 0.5em; display:none; }
        button.saving .spinner { display:inline-block; }
        button.saving span:not(.spinner) {opacity:0.7;}
        @keyframes spin { to { transform: rotate(360deg); } }
        button:hover:not(:disabled), .btn:hover:not(:disabled) { filter: brightness(90%); }
        button:disabled, .btn:disabled { opacity: 0.6; cursor: not-allowed; background-color: var(--disabled-bg); color: var(--text-color-light);}
        .btn-small { padding: 0.4rem 0.8rem; font-size: 0.8rem; }
        .btn-icon { padding: 0.5rem; font-size:1.1em; line-height:1; }
        .btn-danger { background-color: var(--danger); }
        .btn-info { background-color: var(--info); }
        .btn-success { background-color: var(--success); }
        .btn-secondary { background-color: var(--text-color-light); color:white;}

        .filters-section { display: flex; flex-wrap: wrap; gap: 1rem; margin-bottom: 1.5rem; background-color: #f9f9fa; padding: 1rem; border-radius: var(--radius); border: 1px solid var(--border-color); }
        .filters-section .form-group { flex: 1 1 200px; margin-bottom:0; }
        .filters-section label {font-size:0.85em; margin-bottom:0.25rem; display:block; font-weight:500;}
        .filters-section input, .filters-section select {font-size:0.9em; padding:0.5rem; width:100%; border:1px solid var(--border-color); border-radius:var(--radius);}
        .filters-section button {align-self:flex-end;}

        table { width: 100%; border-collapse: collapse; margin-top: 1rem; font-size: 0.85rem; }
        th, td { padding: 0.6rem 0.4rem; border-bottom: 1px solid var(--border-color); text-align: left; vertical-align: middle; white-space: nowrap;}
        th:first-child, td:first-child {text-align:center; width: 40px; padding-left:0.6rem; padding-right:0.6rem;} /* Checkbox */
        th { font-weight: 600; color: #444; background-color: #f9fafb; }
        td.product-name {max-width: 250px; overflow:hidden; text-overflow:ellipsis; white-space:nowrap; cursor:pointer; color:var(--primary); font-weight:500;}
        td.product-name:hover {text-decoration:underline;}
        .status-dot { display: inline-block; width: 9px; height: 9px; border-radius: 50%; margin-right: 5px; vertical-align: middle; }
        .status-PENDENTE { background: var(--warning); } .status-EM_PROGRESSO { background: var(--info); }
        .status-CONCLUIDO_SUCESSO { background: var(--success); } .status-FALHOU { background: var(--danger); }
        .status-NAO_SOLICITADO { background: #bdc3c7; }
        .status-LIMITE_ATINGIDO { background: #7f8c8d; color:white;}
        .status-NENHUMA_FONTE_ENCONTRADA { background: #ecf0f1; color: #34495e; border:1px solid #bdc3c7;}
        .table-actions { margin-top: 1.5rem; display: flex; flex-wrap: wrap; gap: 0.75rem; align-items: center; }
        .pagination-controls { margin-top: 1.5rem; text-align: center;}
        .pagination-controls button {margin: 0 5px;}
        .pagination-controls span {margin: 0 10px; font-size:0.9em;}

        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.5); align-items: center; justify-content: center; }
        .modal.active { display: flex; }
        .modal-content { background-color: var(--card-bg); margin: 2% auto; padding: 0; border-radius: var(--radius); box-shadow: var(--shadow-md); width: 90%; max-width: 850px; display: flex; flex-direction: column; max-height: 95vh; }
        .modal-small .modal-content {max-width: 550px;}
        .modal-header { padding: 1rem 1.5rem; background-color: var(--sidebar-bg); color: white; border-top-left-radius: var(--radius); border-top-right-radius: var(--radius); display: flex; justify-content: space-between; align-items: center; }
        .modal-header h3 { margin: 0; font-size: 1.3em; }
        .modal-header .close-btn { color: white; font-size: 1.5rem; font-weight: bold; cursor: pointer; background: none; border: none; padding: 0.5rem; line-height: 1;}
        .modal-body { padding: 1.5rem; overflow-y: auto; flex-grow: 1; }
        .modal-footer { padding: 1rem 1.5rem; display: flex; justify-content: space-between; align-items:center; gap: 0.5rem; border-top: 1px solid var(--border-color); background-color: #f9fafb; }
        .modal-footer .left-actions { display:flex; gap: 0.5rem; margin-right:auto;}
        .modal-tabs { display: flex; border-bottom: 1px solid var(--border-color); margin-bottom: 1rem; flex-wrap:wrap; }
        .modal-tabs button { background: none; border: none; padding: 0.8rem 1rem; cursor: pointer; font-size: 0.9rem; color: #555; border-bottom: 3px solid transparent; position:relative;}
        .modal-tabs button.active { color: var(--primary); border-bottom-color: var(--primary); font-weight: 600; }
        .modal-tabs button .tab-error-indicator { color: var(--danger); margin-left: 5px; font-weight: bold; display:none; position:absolute; top:2px; right:2px; font-size:0.7em;}
        .modal-tabs button.has-error .tab-error-indicator { display: inline; }
        .tab-pane { display: none; animation: fadeIn 0.3s; }
        .tab-pane.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        .form-group { margin-bottom: 1rem; }
        .form-group label { display: block; margin-bottom: 0.3rem; font-weight: 500; color: #333; }
        .form-group label .required { color: var(--danger); font-weight: bold; margin-left: 2px;}
        .form-group input[type="text"], .form-group input[type="number"], .form-group input[type="date"], .form-group input[type="url"], .form-group select, .form-group textarea { width: 100%; padding: 0.6rem 0.75rem; border: 1px solid var(--border-color); border-radius: var(--radius); font-size: 1rem; }
        .form-group textarea { min-height: 80px; resize: vertical; }
        .form-group input.is-invalid, .form-group select.is-invalid, .form-group textarea.is-invalid { border-color: var(--danger) !important; background-color: #fff5f5; }
        .error-message {font-size:0.8em; color:var(--danger); margin-top:2px; min-height:1em;}
        .attribute-item { display: flex; flex-wrap: wrap; gap: 0.75rem; align-items: flex-end; padding: 0.75rem; border: 1px solid #f0f0f0; border-radius: var(--radius); margin-bottom: 0.75rem; }
        .attribute-item.from-template { background-color: #f9f9f9; }
        .attribute-item.manual-add { background-color: #eef2ff; border-left: 3px solid var(--info); }
        .attribute-item .form-group { flex: 1 1 200px; margin-bottom: 0; }
        .attribute-item .key-input:disabled { background-color: var(--disabled-bg); color: var(--text-color-light); border-style: dashed;}
        .attribute-item .actions { margin-left: auto; align-self: flex-end; }
        .tooltip { position: relative; display: inline-block; cursor: help; margin-left: 4px; color: var(--text-color-light); font-weight: normal; border: 1px solid var(--text-color-light); border-radius: 50%; width: 16px; height:16px; text-align:center; line-height:14px; font-size:0.8em;}
        .tooltip .tooltiptext { visibility: hidden; width: 220px; background-color: #555; color: #fff; text-align: center; border-radius: 6px; padding: 5px 8px; position: absolute; z-index: 1; bottom: 125%; left: 50%; margin-left: -110px; opacity: 0; transition: opacity 0.3s; font-size:0.85em; font-weight:normal; }
        .tooltip:hover .tooltiptext { visibility: visible; opacity: 1; }
        .modal-body h4 { margin-top: 1.2rem; margin-bottom:0.8rem; padding-bottom:0.5rem; border-bottom:1px solid #eee; color:var(--sidebar-bg); display:flex; justify-content:space-between; align-items:center;}
        .modal-body h4:first-child {margin-top:0;}
        .suggestion-box { margin-top: 1.5rem; padding: 1rem; background-color: #eef2ff; border: 1px solid var(--info); border-radius: var(--radius); }
        .suggestion-box h5 { margin-top: 0; margin-bottom: 0.75rem; color: var(--info); }
        .suggestion-box ul { list-style-type: none; padding-left: 0; margin: 0; }
        .suggestion-box li { margin-bottom: 0.5rem; font-size: 0.9em; display: flex; flex-wrap:wrap; align-items: center; gap: 10px; padding-bottom:0.5rem; border-bottom:1px solid #ddd;}
        .suggestion-box li:last-child{border-bottom:none;}
        .suggestion-box li label {font-weight:bold; flex-basis:180px; flex-shrink:0;}
        .suggestion-box li input[type="text"], .suggestion-box li input[type="checkbox"] {flex-grow:1; padding:0.4rem 0.6rem; font-size:0.9em;}
        .suggestion-box li input[type="checkbox"] {flex-grow:0; width:auto;}
        /* Gerenciamento de Tipos */
        .type-management-container { display: flex; gap: 1.5rem; }
        .type-list-panel { flex: 1; max-width:300px; }
        .type-detail-panel { flex: 2; background-color: #f9f9fa; padding: 1rem; border-radius: var(--radius); border: 1px solid var(--border-color); min-height: 400px;}
        .type-list-panel ul { list-style-type: none; padding: 0; }
        .type-list-panel li { padding: 0.6rem; border-bottom: 1px solid var(--border-color); cursor: pointer; border-radius: 4px; margin-bottom:4px; display:flex; justify-content:space-between; align-items:center; }
        .type-list-panel li:hover, .type-list-panel li.selected { background-color: var(--primary); color: white; }
        .type-list-panel li .type-actions button { padding: 0.2em 0.4em; font-size: 0.8em; background: rgba(255,255,255,0.2); margin-left:5px; }
        .type-list-panel li.selected .type-actions button { background: rgba(255,255,255,0.3); color:white;}
        .type-list-panel li .usage-count {font-size:0.8em; opacity:0.7;}
        .type-detail-panel .panel-header { margin-top: 0; margin-bottom: 1rem; display:flex; justify-content:space-between; align-items:center;}
        #attributesTemplateList {display:flex; flex-direction:column; gap:0.5rem;}
        .attribute-template-card { display:flex; justify-content:space-between; align-items:flex-start; padding:0.75rem; border:1px solid #d1d5db; margin-bottom:0.5rem; border-radius:var(--radius); background:white; box-shadow: var(--shadow-sm); }
        .attribute-template-card .main-info {flex-grow:1;}
        .attribute-template-card .main-info strong {font-size:1.05em; color: var(--sidebar-bg); display:block; margin-bottom:0.25em;}
        .attribute-template-card .details { font-size:0.85em; color:var(--text-color-light); line-height:1.4;}
        .attribute-template-card .details .detail-item {margin-right:10px; display:inline-block;}
        .attribute-template-card .details .detail-item strong {color:#555;}
        .attribute-template-card .attr-controls {display:flex; flex-direction:column; gap:0.25rem; align-items:flex-end;}
        .attribute-template-card .attr-order-icons {display:flex; gap:0.25rem; margin-bottom:0.25rem;}
        .attribute-template-card .attr-order-icons button, .attribute-template-card .attr-actions button { padding:2px 4px; background:none; border:1px solid #ccc; color:#555; display:flex; align-items:center; justify-content:center; line-height:1;}
        .attribute-template-card .attr-order-icons button:disabled {opacity:0.4; cursor:not-allowed;}
        .loading-indicator { font-style: italic; color: var(--text-color-light); padding: 10px 0; text-align:center; }
        .ia-note {font-size:0.85em; color:var(--text-color-light); margin-top:1rem; padding:0.5rem; background-color:#f9f9f9; border-radius:var(--radius);}
        .diff-view {display:flex; gap:1rem; margin-bottom:1rem; border:1px solid #ddd; padding:0.5rem; border-radius:var(--radius);}
        .diff-view > div {flex:1;}
        .diff-view label {font-size:0.8em; color:var(--text-color-light); margin-bottom:0.2rem; display:block;}
        .diff-view textarea {height:100px; font-size:0.9em;}
        .media-item {display:flex; gap:10px; align-items:center; margin-bottom:10px; padding:10px; border:1px solid #eee; border-radius:var(--radius);}
        .media-item img.preview {width:60px; height:60px; object-fit:cover; border-radius:4px;}
        .media-item .fields {flex-grow:1;}
        .media-item .fields .form-group {margin-bottom:5px;}
        .media-item .fields input {font-size:0.9em; padding:0.4em;}
        .history-item {padding:0.5rem 0; border-bottom:1px dotted #eee; font-size:0.85em;}
        .history-item:last-child{border-bottom:none;}
        .history-item .actor {font-weight:bold;}
        .history-item .date {color:var(--text-color-light); margin-left:10px;}
        .global-message { padding: 1rem; margin: 1rem 0; border-radius: var(--radius); text-align:center; font-weight:500; }
        .global-message.error { background-color: #ffebee; color: var(--danger); border:1px solid var(--danger);}
        .global-message.success { background-color: #e8f5e9; color: var(--success); border:1px solid var(--success);}
        .global-message.info { background-color: #e3f2fd; color: var(--primary); border:1px solid var(--primary);}
        .global-message.warning { background-color: #fff8e1; color: var(--warning); border:1px solid var(--warning);}
    </style>
</head>
<body>
    <aside class="sidebar">
        <div class="logo">CatalogAI</div>
        <nav>
            <a href="#" onclick="showView('view-dashboard')" id="nav-dashboard">Dashboard</a>
            <a href="#" onclick="showView('view-produtos')" id="nav-produtos" class="active">Produtos</a>
            <a href="#" onclick="showView('view-tipos-produto')" id="nav-tipos-produto">Tipos de Produto</a>
            <a href="#" onclick="showView('view-configuracoes')" id="nav-configuracoes">Configura√ß√µes</a>
        </nav>
    </aside>

    <div class="main">
        <header class="topbar">
            <h1 id="viewTitle">Produtos</h1>
        </header>

        <main class="content">
            <div id="globalUserMessage" class="global-message hidden"></div>

            <div id="view-dashboard" class="hidden">Dashboard Content Here...</div>
            
            <div id="view-produtos">
                <div class="filters-section">
                    <div class="form-group">
                        <label for="prod-search-term">Buscar Produtos:</label>
                        <input type="text" id="prod-search-term" placeholder="Nome, SKU ou Marca...">
                    </div>
                    <div class="form-group">
                        <label for="prod-filter-status-enr">Status Enriq. Web:</label>
                        <select id="prod-filter-status-enr">
                            <option value="">Todos</option><option value="PENDENTE">Pendente</option>
                            <option value="EM_PROGRESSO">Em Progresso</option> <option value="CONCLUIDO_SUCESSO">Sucesso</option>
                            <option value="FALHOU">Falhou</option><option value="NENHUMA_FONTE_ENCONTRADA">Fonte √ë Enc.</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="prod-filter-status-tit">Status T√≠tulos IA:</label>
                        <select id="prod-filter-status-tit">
                            <option value="">Todos</option><option value="NAO_SOLICITADO">N√£o Solicitado</option>
                            <option value="PENDENTE">Pendente</option><option value="EM_PROGRESSO">Em Progresso</option>
                            <option value="CONCLUIDO_SUCESSO">Sucesso</option><option value="FALHOU">Falhou</option>
                            <option value="LIMITE_ATINGIDO">Limite Atingido</option>
                        </select>
                    </div>
                     <div class="form-group">
                        <label for="prod-filter-status-desc">Status Descri√ß√£o IA:</label>
                        <select id="prod-filter-status-desc">
                            <option value="">Todos</option><option value="NAO_SOLICITADO">N√£o Solicitado</option>
                            <option value="PENDENTE">Pendente</option><option value="EM_PROGRESSO">Em Progresso</option>
                            <option value="CONCLUIDO_SUCESSO">Sucesso</option><option value="FALHOU">Falhou</option>
                            <option value="LIMITE_ATINGIDO">Limite Atingido</option>
                        </select>
                    </div>
                    <button class="btn-small btn-primary" onclick="applyProductTableFilters()">üîç Filtrar</button>
                </div>

                <div class="card">
                    <div class="card-header">
                        <h3>Lista de Produtos (<span id="total-products-count">0</span>)</h3>
                        <button onclick="openModal('productModal', true)">‚ú® Novo Produto</button>
                    </div>
                    <table id="products-main-table">
                        <thead>
                            <tr>
                                <th><input type="checkbox" id="select-all-products-checkbox" onchange="toggleAllProductCheckboxes(this.checked)"></th>
                                <th>Nome Base</th>
                                <th>SKU</th>
                                <th>Marca</th>
                                <th>Status Enriq.</th>
                                <th>Status T√≠tulo</th>
                                <th>Status Desc.</th>
                                <th>Cria√ß√£o</th>
                            </tr>
                        </thead>
                        <tbody id="products-table-body-content">
                            </tbody>
                    </table>
                    <div class="pagination-controls">
                        <button class="btn-small" id="prev-page-btn" disabled><span>¬´</span> Anterior</button>
                        <span id="page-info-span">P√°gina 1 de 1</span>
                        <button class="btn-small" id="next-page-btn" disabled>Pr√≥xima <span>¬ª</span></button>
                    </div>
                    <div class="table-actions">
                        <button id="btn-enrich-web-batch" class="btn-info" disabled>üåê Enriquecer Web (<span class="selected-count">0</span>)</button>
                        <button id="btn-gen-titles-batch" disabled>ü§ñ Gerar T√≠tulos (<span class="selected-count">0</span>)</button>
                        <button id="btn-gen-descs-batch" disabled>üìÑ Gerar Descri√ß√µes (<span class="selected-count">0</span>)</button>
                        <button id="btn-delete-batch" class="btn-danger" disabled>üóëÔ∏è Deletar (<span class="selected-count">0</span>)</button>
                    </div>
                </div>
            </div>
            
            <div id="view-tipos-produto" class="hidden">
                 <div class="card">
                     <div class="card-header">
                         <h3>Gerenciar Tipos de Produto</h3>
                         <div>
                             <button onclick="cloneSelectedProductType()" id="btnCloneProductType" class="btn-info btn-small" disabled>Clonar Tipo</button>
                             <button onclick="openNewProductTypeDefinitionModal()" class="btn-success btn-small">Novo Tipo de Produto</button>
                         </div>
                     </div>
                     <div class="type-management-container">
                         <div class="type-list-panel">
                             <h4>Tipos Cadastrados:</h4>
                             <ul id="productTypesListUL"></ul>
                         </div>
                         <div class="type-detail-panel" id="productTypeDetailView">
                             <div class="panel-header">
                                 <h5>Selecione um Tipo para ver/editar.</h5>
                                 <button id="btnShowAddAttrForm" class="btn-small btn-primary hidden" onclick="openAttributeTemplateModal(null)">+ Novo Atributo para Template</button>
                             </div>
                             <div id="attributesTemplateList"></div>
                         </div>
                     </div>
                 </div>
             </div>
            <div id="view-configuracoes" class="hidden">Configura√ß√µes Content Here...</div>
        </main>
    </div>
    
    <div class="modal modal-small" id="attributeTemplateModal">
        <div class="modal-content">
            <div class="modal-header"> <h3 id="attributeTemplateModalTitle">Adicionar Atributo</h3> <button class="close-btn" onclick="closeModal('attributeTemplateModal')">√ó</button> </div>
            <div class="modal-body">
                 <form id="attributeDefinitionForm" class="attribute-field-editor" onsubmit="event.preventDefault(); confirmSaveAttributeToTemplate(this.querySelector('button[type=submit]'));">
                   <input type="hidden" id="editingAttrId">
                   <div class="form-group"><label for="tmplAttrName">Nome do Atributo<span class="required">*</span></label><input type="text" id="tmplAttrName" required></div>
                   <div class="form-group"><label for="tmplAttrType">Tipo de Dado<span class="required">*</span></label>
                       <select id="tmplAttrType" onchange="toggleAttributeOptionsInput(this.value, 'tmplAttrOptionsGroup', 'tmplAttrOptions')" required>
                           <option value="text">Texto Curto</option><option value="textarea">Texto Longo</option>
                           <option value="number">N√∫mero</option><option value="date">Data</option>
                           <option value="boolean">Sim/N√£o (Checkbox)</option><option value="select">Lista de Op√ß√µes</option>
                       </select>
                   </div>
                   <div class="form-group hidden" id="tmplAttrOptionsGroup"><label for="tmplAttrOptions">Op√ß√µes (v√≠rgula-sep)<span class="required">*</span></label><input type="text" id="tmplAttrOptions"></div>
                   <div class="form-group"><label for="tmplAttrTooltip">Tooltip (dica)</label><input type="text" id="tmplAttrTooltip"></div>
                   <div class="form-group"><label for="tmplAttrDefaultValue">Valor Padr√£o</label><input type="text" id="tmplAttrDefaultValue"></div>
                   <div class="form-group" style="flex-direction:row; align-items:center; gap:5px;"><input type="checkbox" id="tmplAttrRequired" style="width:auto;"> <label for="tmplAttrRequired" style="margin-bottom:0;">Obrigat√≥rio</label></div>
                   <div class="modal-footer" style="padding:0; border-top:none; background:none; margin-top:1rem;">
                       <button type="button" class="btn-secondary" onclick="closeModal('attributeTemplateModal')">Cancelar</button>
                       <button type="submit" class="btn-success"><span class="spinner"></span><span>üíæ Salvar Atributo</span></button>
                   </div>
                </form>
            </div>
        </div>
    </div>
    <div class="modal" id="productModal">
         <div class="modal-content">
            <div class="modal-header"> <h3 id="productModalTitle">Novo Produto</h3> <button class="close-btn" onclick="closeModal('productModal')">√ó</button> </div>
            <div class="modal-body">
                <div class="form-group">
                    <label for="productTypeSelector">Tipo de Produto:</label>
                    <select id="productTypeSelector" onchange="handleProductTypeChange(this.value)"> <option value="">Selecione...</option> </select>
                </div>
                <div id="productFormLoadingIndicator" class="loading-indicator hidden">Carregando template...</div>
                <div class="modal-tabs">
                    <button class="tab-button active" onclick="openProductTab(event, 'tab-p-info')">Info Principais <span class="tab-error-indicator">!</span></button>
                    <button class="tab-button" onclick="openProductTab(event, 'tab-p-atributos')">Atributos <span class="tab-error-indicator">!</span></button>
                    <button class="tab-button" onclick="openProductTab(event, 'tab-p-midia')">M√≠dia <span class="tab-error-indicator">!</span></button>
                    <button class="tab-button" onclick="openProductTab(event, 'tab-p-ia')">Conte√∫do IA <span class="tab-error-indicator">!</span></button>
                    <button class="tab-button" onclick="openProductTab(event, 'tab-p-sugestoes')">Sugest√µes IA</button>
                    <button class="tab-button" onclick="openProductTab(event, 'tab-p-historico')">Hist√≥rico</button>
                </div>
                <div id="tab-p-info" class="tab-pane active">
                    <h4>Informa√ß√µes Base</h4>
                    <div class="form-group">
                        <label for="p-nome_base">Nome Base<span class="required">*</span></label>
                        <input type="text" id="p-nome_base" data-fieldname="Nome Base" placeholder="Nome principal do produto" oninput="debouncedValidateField(this, 'p-nome_base-error', 'Nome Base', {required:true, minLength: 3})">
                        <span class="error-message" id="p-nome_base-error"></span>
                    </div>
                    <div class="form-group"><label for="p-sku_original">SKU Original</label><input type="text" id="p-sku_original" data-fieldname="SKU Original" placeholder="SKU do fornecedor" oninput="debouncedValidateField(this, 'p-sku_original-error', 'SKU Original', {maxLength: 50})"><span class="error-message" id="p-sku_original-error"></span></div>
                    <div class="form-group"><label for="p-marca">Marca</label><input type="text" id="p-marca" data-fieldname="Marca" placeholder="Marca do produto" oninput="debouncedValidateField(this, 'p-marca-error', 'Marca', {maxLength: 100})"><span class="error-message" id="p-marca-error"></span></div>
                </div>
                <div id="tab-p-atributos" class="tab-pane">
                    <h4>Atributos Espec√≠ficos para: <span id="currentProductTypeDisplay">Nenhum tipo</span></h4>
                    <div id="dynamic-attributes-list"> <p style="color: var(--text-color-light);">Selecione um Tipo de Produto.</p> </div>
                    <button class="btn-small btn-info" onclick="addAttributeManually()" style="margin-top:10px;">+ Atributo Manual</button>
                </div>
                <div id="tab-p-midia" class="tab-pane">
                    <h4>M√≠dia do Produto</h4><h5>Imagens</h5><div id="p-images-list"></div><button class="btn-small btn-info" onclick="addImageField()">+ Add Imagem (URL)</button>
                    <h5 style="margin-top:1.5rem;">V√≠deos</h5><div id="p-videos-list"></div><button class="btn-small btn-info" onclick="addVideoField()">+ Add V√≠deo (URL)</button>
                </div>
                <div id="tab-p-ia" class="tab-pane">
                     <h4>Conte√∫do Gerado/Editado</h4>
                    <div class="form-group"> <label>Descri√ß√£o Principal</label> <div class="diff-view"> <div><label>Original</label><textarea id="p-descricao-original-display" rows="5" readonly disabled style="background:#f0f0f0;"></textarea></div><div><label>Sugest√£o IA / Edit√°vel</label><textarea id="p-descricao_principal" rows="5" placeholder="..."></textarea></div> </div> <button class="btn-small" onclick="generateAIDescription(this)"><span class="spinner"></span><span>Gerar Descri√ß√£o</span></button> <button class="btn-small btn-success" onclick="applyAIDescription()">Aplicar</button> </div>
                    <div class="form-group"> <label>T√≠tulos Sugeridos (M√°x. 5)</label> <div id="p-titles-list"></div> <button class="btn-small btn-info" onclick="addTitleField()">+ Add T√≠tulo Manual</button> <button class="btn-small" onclick="generateAITitles(this)"><span class="spinner"></span><span>Gerar T√≠tulos</span></button> </div>
                     <p class="ia-note">Nota: A IA utilizar√° o Tipo e Atributos como contexto.</p>
                </div>
                <div id="tab-p-sugestoes" class="tab-pane">
                    <h4>Sugest√µes (Tipo: <span class="currentProductTypeDisplay">Nenhum</span>)</h4>
                    <div id="iaSuggestionsLoadingIndicator" class="loading-indicator hidden">IA buscando...</div>
                    <div class="suggestion-box" id="ia-attribute-suggestions"> <h5>A IA sugere:</h5> <ul id="ia-suggested-attributes-list"> <li style="color: var(--text-color-light);">Selecione Tipo e Nome Base.</li> </ul> <button class="btn-small btn-primary" onclick="fetchIASuggestedValues(this)" style="margin-top:10px;"><span class="spinner"></span><span>Buscar Valores (IA)</span></button> </div>
                </div>
                <div id="tab-p-historico" class="tab-pane"> <h4>Hist√≥rico (Simulado)</h4> <ul id="product-history-list" style="list-style:none; padding-left:0;"> <li class="history-item">Criado. <span class="actor">por Admin</span> <span class="date">01/06/2025</span></li> </ul> </div>
            </div>
            <div class="modal-footer">
                <div class="left-actions"> <button class="btn-secondary" onclick="saveProduct(true, this)"><span class="spinner"></span><span>Rascunho</span></button> </div>
                <div> <button class="btn-secondary" onclick="closeModal('productModal')">Cancelar</button> <button class="btn-primary" onclick="saveProductAndNew(this)"><span class="spinner"></span><span>Salvar & Novo</span></button> <button class="btn-success" onclick="saveProduct(false, this)"><span class="spinner"></span><span>Salvar Produto</span></button> </div>
            </div>
        </div>
    </div>

    <script>
        // --- DADOS MOCKADOS ---
        let productTypeTemplates = {
            'eletronico': { friendlyName: 'Eletr√¥nico', attributesOrder: ['attr_volt', 'attr_cor_ele', 'attr_pot'], attributes: [ { id: 'attr_volt', name: 'Voltagem', type: 'select', options: ['110V', '220V', 'Bivolt'], required: true, tooltip: 'Voltagem de opera√ß√£o.', defaultValue: 'Bivolt' }, { id: 'attr_pot', name: 'Pot√™ncia (W)', type: 'number', required: false, placeholder: 'Ex: 60', tooltip: 'Consumo em Watts.', defaultValue: '' }, { id: 'attr_cor_ele', name: 'Cor Principal', type: 'text', required: true, placeholder: 'Ex: Preto', tooltip: 'Cor do aparelho.', defaultValue: 'Preto' } ] },
            'vestuario': { friendlyName: 'Vestu√°rio', attributesOrder: ['attr_tam', 'attr_cor_ves', 'attr_mat'], attributes: [ { id: 'attr_cor_ves', name: 'Cor', type: 'text', required: true, placeholder: 'Ex: Azul Marinho', tooltip: 'Cor da pe√ßa.' }, { id: 'attr_tam', name: 'Tamanho', type: 'select', options: ['P', 'M', 'G', 'GG'], required: true, tooltip: 'Tamanho (P, M, G, etc.).', defaultValue: 'M' }, { id: 'attr_mat', name: 'Material', type: 'textarea', required: false, placeholder: 'Ex: Algod√£o, Poli√©ster', tooltip: 'Composi√ß√£o do tecido.' } ] },
            'automotivo_generico': {  friendlyName: 'Automotivo Gen√©rico', attributesOrder: ['attr_comp_auto', 'attr_sku_fab_auto'], attributes: [ { id: 'attr_comp_auto', name: 'Compatibilidade Veicular', type: 'textarea', required: false, placeholder: 'Ex: Universal, Ford Ka 2015+', tooltip: 'Ve√≠culos compat√≠veis.' }, { id: 'attr_sku_fab_auto', name: 'SKU Fabricante', type: 'text', required: false, placeholder: 'Part number', tooltip: 'C√≥digo original do fabricante.' } ]  }
        };
        const sampleProducts = [
            {id: 1, nome_base: 'Geladeira Port√°til 18L', sku_original: 'SAN_7766700014', marca: 'DREIHA', status_enriquecimento_web: 'CONCLUIDO_SUCESSO', status_titulo_ia: 'CONCLUIDO_SUCESSO', status_descricao_ia: 'EM_PROGRESSO', created_at: '2025-05-20T10:00:00Z', productTypeId: 'automotivo_generico', atributos: {'Compatibilidade Veicular': 'Universal', 'SKU Fabricante': 'SN7766700014'}},
            {id: 2, nome_base: 'Base Deslizante Refrigerador CBX', sku_original: 'SAN_7766700025', marca: 'DREIHA', status_enriquecimento_web: 'PENDENTE', status_titulo_ia: 'NAO_SOLICITADO', status_descricao_ia: 'NAO_SOLICITADO', created_at: '2025-05-18T12:30:00Z', productTypeId: 'automotivo_generico', atributos: {'Material': 'A√ßo Refor√ßado'}},
            {id: 3, nome_base: 'Cabo For√ßa Universal Veicular 12V', sku_original: 'CAB-UNI-001', marca: 'Gen√©rico', status_enriquecimento_web: 'FALHOU', status_titulo_ia: 'LIMITE_ATINGIDO', status_descricao_ia: 'FALHOU', created_at: '2025-05-17T09:15:00Z', productTypeId: 'eletronico', atributos: {'Voltagem': 'Bivolt', 'Cor Principal': 'Preto'}}, // Corrigido para Bivolt para teste de defaultValue
            {id: 4, nome_base: 'Camiseta Algod√£o Premium Lisa', sku_original: 'CAM-PREM-01', marca: 'StyleWear', status_enriquecimento_web: 'CONCLUIDO_SUCESSO', status_titulo_ia: 'PENDENTE', status_descricao_ia: 'PENDENTE', created_at: '2025-05-19T11:00:00Z', productTypeId: 'vestuario', atributos: {'Cor': 'Branca', 'Tamanho':'G', 'Material':'100% Algod√£o'}}
        ];
        let currentSelectedProductTypeForAdmin = null;
        let editingAttributeTemplateId = null;
        let debouncedValidateTimer; 
        let productCheckboxesState = {};
        let currentPage = 0;
        const itemsPerPage = 3; 
        let filteredSampleProducts = []; 

        // --- FUN√á√ïES DE NAVEGA√á√ÉO E UI GERAL ---
        function showView(viewId) {
            document.querySelectorAll('.content > div:not(#globalUserMessage)').forEach(v => v.classList.add('hidden'));
            document.querySelectorAll('.sidebar nav a').forEach(nav => nav.classList.remove('active'));
            const targetView = document.getElementById(viewId);
            const targetNav = document.getElementById('nav-' + viewId.replace('view-', ''));
            if(targetView) targetView.classList.remove('hidden');
            if(targetNav) targetNav.classList.add('active');
            document.getElementById('viewTitle').textContent = targetNav.textContent;
        }
        function openModal(modalId, isNew = false, data = null) {
            const modal = document.getElementById(modalId);
            if (modal) modal.style.display = 'flex';

            if (modalId === 'productModal') {
                document.getElementById('productModalTitle').textContent = isNew ? 'Novo Produto' : `Editar Produto: ${data ? data.nome_base : 'Carregando...'}`;
                clearProductModalForm();
                if (isNew) {
                    document.getElementById('productTypeSelector').value = '';
                    handleProductTypeChange('');
                } else if (data) {
                    document.getElementById('p-nome_base').value = data.nome_base || '';
                    document.getElementById('p-sku_original').value = data.sku_original || '';
                    document.getElementById('p-marca').value = data.marca || '';
                    if (data.midia && data.midia.imagens) {
                        data.midia.imagens.forEach(img => addImageField(img.url, img.alt, img.principal));
                    }
                    if (data.midia && data.midia.videos) {
                        data.midia.videos.forEach(vid => addVideoField(vid.url, vid.titulo));
                    }
                    document.getElementById('p-descricao_principal').value = data.descricao_principal || '';
                    document.getElementById('p-descricao-original-display').value = data.descricao_original || '';
                    document.getElementById('p-titles-list').innerHTML = '';
                    if (data.titulos_sugeridos) {
                        data.titulos_sugeridos.forEach(t => addTitleField(t));
                    }
                    const productTypeToSelect = data.productTypeId || '';
                    document.getElementById('productTypeSelector').value = productTypeToSelect;
                    // Passar os atributos espec√≠ficos do produto para handleProductTypeChange
                    handleProductTypeChange(productTypeToSelect, data.atributos || {}); 
                }
                openProductTab(null, 'tab-p-info');
            } else if (modalId === 'attributeTemplateModal') {
                document.getElementById('attributeDefinitionForm').reset();
                document.getElementById('editingAttrId').value = '';
                toggleAttributeOptionsInput('text', 'tmplAttrOptionsGroup', 'tmplAttrOptions');
            }
        }
        function closeModal(modalId) {  const modal = document.getElementById(modalId); if (modal) modal.style.display = 'none'; }
        function clearProductModalForm() {
            document.getElementById('p-nome_base').value = '';
            document.getElementById('p-sku_original').value = '';
            document.getElementById('p-marca').value = '';
            document.getElementById('p-descricao_principal').value = '';
            document.getElementById('p-descricao-original-display').value = '';
            document.getElementById('p-titles-list').innerHTML = '';
            document.getElementById('p-images-list').innerHTML = '';
            document.getElementById('p-videos-list').innerHTML = '';
            document.getElementById('dynamic-attributes-list').innerHTML = '<p style="color: var(--text-color-light);">Selecione um Tipo de Produto para ver atributos.</p>';
            document.getElementById('ia-suggested-attributes-list').innerHTML = '<li style="color: var(--text-color-light);">Selecione um tipo para sugest√µes.</li>';
            document.querySelectorAll('.modal-tabs button .tab-error-indicator').forEach(el => el.style.display = 'none');
            document.querySelectorAll('.modal-body .is-invalid').forEach(el => el.classList.remove('is-invalid'));
            document.querySelectorAll('.modal-body .error-message').forEach(el => el.textContent = '');
        }
        function showGlobalMessage(message, type = 'info') {
            const msgDiv = document.getElementById('globalUserMessage');
            msgDiv.textContent = message;
            msgDiv.className = `global-message ${type}`;
            msgDiv.classList.remove('hidden');
            setTimeout(() => msgDiv.classList.add('hidden'), 5000);
        }

        // --- L√ìGICA DA P√ÅGINA DE PRODUTOS ---
        function renderProductRow(p) {
            const statusEnr = p.status_enriquecimento_web || 'PENDENTE';
            const statusTit = p.status_titulo_ia || 'NAO_SOLICITADO';
            const statusDesc = p.status_descricao_ia || 'NAO_SOLICITADO';
            const encodedProductData = encodeURIComponent(JSON.stringify(p));
            return `
                <tr data-product-id="${p.id}" onclick="openModal('productModal', false, JSON.parse(decodeURIComponent('${encodedProductData}')))">
                    <td><input type="checkbox" class="product-checkbox" data-id="${p.id}" ${productCheckboxesState[p.id] ? 'checked' : ''} onclick="event.stopPropagation(); toggleProductCheckbox(${p.id}, this.checked);"></td>
                    <td class="product-name" title="${p.nome_base}">${p.nome_base}</td>
                    <td title="${p.sku_original}">${p.sku_original}</td>
                    <td title="${p.marca || 'N/A'}">${p.marca || 'N/A'}</td>
                    <td><span class="status-dot status-${statusEnr}"></span> ${statusEnr.replace(/_/g, ' ')}</td>
                    <td><span class="status-dot status-${statusTit}"></span> ${statusTit.replace(/_/g, ' ')}</td>
                    <td><span class="status-dot status-${statusDesc}"></span> ${statusDesc.replace(/_/g, ' ')}</td>
                    <td>${new Date(p.created_at).toLocaleDateString()}</td>
                </tr>`;
        }
        function displayProductsPage() {
            const tbody = document.getElementById('products-table-body-content');
            tbody.innerHTML = '';
            const start = currentPage * itemsPerPage;
            const end = start + itemsPerPage;
            const paginatedItems = filteredSampleProducts.slice(start, end);

            if (paginatedItems.length === 0 && filteredSampleProducts.length > 0 && currentPage > 0) { // Se apagou a √∫ltima p√°gina, volta uma
                currentPage--;
                displayProductsPage(); // Chama recursivamente
                return;
            }
             if (paginatedItems.length === 0 && filteredSampleProducts.length === 0) {
                tbody.innerHTML = '<tr><td colspan="8" style="text-align:center; padding:20px; color:var(--text-color-light);">Nenhum produto encontrado com os filtros atuais.</td></tr>';
            } else {
                 paginatedItems.forEach(p => {
                    tbody.insertAdjacentHTML('beforeend', renderProductRow(p));
                });
            }


            document.getElementById('total-products-count').textContent = filteredSampleProducts.length;
            const totalPages = Math.ceil(filteredSampleProducts.length / itemsPerPage) || 1;
            document.getElementById('page-info-span').textContent = `P√°gina ${currentPage + 1} de ${totalPages}`;
            document.getElementById('prev-page-btn').disabled = currentPage === 0;
            document.getElementById('next-page-btn').disabled = currentPage >= totalPages - 1;
            updateBatchActionButtons();
        }
        
        document.getElementById('prev-page-btn').addEventListener('click', () => { if (currentPage > 0) { currentPage--; displayProductsPage(); } });
        document.getElementById('next-page-btn').addEventListener('click', () => { if (currentPage < Math.ceil(filteredSampleProducts.length / itemsPerPage) - 1) { currentPage++; displayProductsPage(); } });

        function applyProductTableFilters() {
            const searchTerm = document.getElementById('prod-search-term').value.toLowerCase();
            const statusEnr = document.getElementById('prod-filter-status-enr').value;
            const statusTit = document.getElementById('prod-filter-status-tit').value;
            const statusDesc = document.getElementById('prod-filter-status-desc').value;
            
            productCheckboxesState = {}; 
            document.getElementById('select-all-products-checkbox').checked = false;


            filteredSampleProducts = sampleProducts.filter(p => {
                const matchesSearch = (!searchTerm || 
                                     (p.nome_base && p.nome_base.toLowerCase().includes(searchTerm)) ||
                                     (p.sku_original && p.sku_original.toLowerCase().includes(searchTerm)) ||
                                     (p.marca && p.marca.toLowerCase().includes(searchTerm)));
                const pStatusEnr = p.status_enriquecimento_web || 'PENDENTE';
                const pStatusTit = p.status_titulo_ia || 'NAO_SOLICITADO';
                const pStatusDesc = p.status_descricao_ia || 'NAO_SOLICITADO';

                const matchesStatusEnr = (!statusEnr || pStatusEnr === statusEnr);
                const matchesStatusTit = (!statusTit || pStatusTit === statusTit);
                const matchesStatusDesc = (!statusDesc || pStatusDesc === statusDesc);
                return matchesSearch && matchesStatusEnr && matchesStatusTit && matchesStatusDesc;
            });
            currentPage = 0; 
            displayProductsPage();
        }
        ['prod-search-term', 'prod-filter-status-enr', 'prod-filter-status-tit', 'prod-filter-status-desc'].forEach(id => {
            const el = document.getElementById(id);
            if(el) el.addEventListener(id === 'prod-search-term' ? 'input' : 'change', applyProductTableFilters);
        });

        function toggleAllProductCheckboxes(checked){
            const checkboxes = document.querySelectorAll('#products-table-body-content .product-checkbox');
            checkboxes.forEach(cb => {
                cb.checked = checked;
                productCheckboxesState[cb.dataset.id] = checked;
            });
            updateBatchActionButtons();
        }
        function toggleProductCheckbox(id, checked){
            productCheckboxesState[id] = checked;
            const allCheckboxes = document.querySelectorAll('#products-table-body-content .product-checkbox');
            const selectAllMaster = document.getElementById('select-all-products-checkbox');
            selectAllMaster.checked = allCheckboxes.length > 0 && Array.from(allCheckboxes).every(cb => cb.checked);
            updateBatchActionButtons();
        }
        function updateBatchActionButtons(){
            const selectedCount = Object.values(productCheckboxesState).filter(Boolean).length;
            document.querySelectorAll('.selected-count').forEach(el => el.textContent = selectedCount);
            document.querySelectorAll('.table-actions button').forEach(btn => btn.disabled = selectedCount === 0);
        }
        document.getElementById('btn-enrich-web-batch').onclick = () => alert(`Enriquecer Web para ${Object.values(productCheckboxesState).filter(Boolean).length} produtos (simulado)`);
        document.getElementById('btn-gen-titles-batch').onclick = () => alert(`Gerar T√≠tulos para ${Object.values(productCheckboxesState).filter(Boolean).length} produtos (simulado)`);
        document.getElementById('btn-gen-descs-batch').onclick = () => alert(`Gerar Descri√ß√µes para ${Object.values(productCheckboxesState).filter(Boolean).length} produtos (simulado)`);
        document.getElementById('btn-delete-batch').onclick = () => {
            const selectedIds = Object.keys(productCheckboxesState).filter(id => productCheckboxesState[id]);
            if (selectedIds.length > 0 && confirm(`Deletar ${selectedIds.length} produtos? (simulado)`)) {
                // L√≥gica de dele√ß√£o simulada (removeria de sampleProducts e atualizaria a tabela)
                showGlobalMessage(`${selectedIds.length} produtos deletados (simulado).`, 'success');
                productCheckboxesState = {}; // Limpa sele√ß√£o
                // Aqui, em uma aplica√ß√£o real, voc√™ atualizaria 'sampleProducts' e chamaria 'applyProductTableFilters()'
                // ou faria uma nova busca ao backend.
                // Por simplicidade no prot√≥tipo, apenas limpamos a sele√ß√£o e o usu√°rio pode re-filtrar.
                applyProductTableFilters(); 
            }
        };


        // --- L√ìGICA DO MODAL DE PRODUTO ---
        function openProductTab(event, tabName) {
            document.querySelectorAll('#productModal .tab-pane').forEach(p => p.classList.remove('active'));
            document.querySelectorAll('#productModal .tab-button').forEach(b => {
                b.classList.remove('active');
            });
            document.getElementById(tabName).classList.add('active');
            const clickedButton = event ? event.currentTarget : document.querySelector(`.modal-tabs button[onclick*="${tabName}"]`);
            if (clickedButton) clickedButton.classList.add('active');
        }
        function populateProductTypeSelector() {
            const selector = document.getElementById('productTypeSelector');
            selector.innerHTML = '<option value="">Selecione...</option>';
            for (const typeKey in productTypeTemplates) {
                selector.innerHTML += `<option value="${typeKey}">${productTypeTemplates[typeKey].friendlyName}</option>`;
            }
        }
        function handleProductTypeChange(typeKey, existingAttributes = null) {
            const loadingIndicator = document.getElementById('productFormLoadingIndicator');
            loadingIndicator.classList.remove('hidden');
            
            setTimeout(() => {
                const attributesContainer = document.getElementById('dynamic-attributes-list');
                const typeDisplayElements = document.querySelectorAll('.currentProductTypeDisplay');
                const iaSuggestionsList = document.getElementById('ia-suggested-attributes-list');
                const typeTemplate = productTypeTemplates[typeKey];

                attributesContainer.innerHTML = '';
                const typeName = typeTemplate ? typeTemplate.friendlyName : "Nenhum tipo";
                typeDisplayElements.forEach(el => el.textContent = typeName);

                if (typeTemplate && typeTemplate.attributes) {
                    const orderedAttributes = typeTemplate.attributesOrder && typeTemplate.attributesOrder.length > 0 ?
                        typeTemplate.attributesOrder.map(id => typeTemplate.attributes.find(attr => attr.id === id)).filter(Boolean) :
                        typeTemplate.attributes;

                    orderedAttributes.forEach(attrConfig => {
                        // Usa valor de 'existingAttributes' se existir, sen√£o usa 'defaultValue' do template
                        const currentValue = existingAttributes ? (existingAttributes[attrConfig.name] !== undefined ? existingAttributes[attrConfig.name] : (existingAttributes[attrConfig.id] !== undefined ? existingAttributes[attrConfig.id] : attrConfig.defaultValue)) : attrConfig.defaultValue;
                        const item = createAttributeItemHTML(attrConfig.id, attrConfig, currentValue || null, true);
                        attributesContainer.appendChild(item);
                    });
                     iaSuggestionsList.innerHTML = orderedAttributes
                        .map(attr => `<li><label for="ia-sug-${attr.id}">${attr.name}:</label> <input type="text" id="ia-sug-${attr.id}" placeholder="IA buscando..."> <span class="ia-confidence"></span> <button class="btn-small btn-success" onclick="applyIASuggestion('${attr.id}', '${attr.name}')">Aplicar</button></li>`)
                        .join('') || '<li>Nenhuma sugest√£o de atributo espec√≠fica.</li>';
                } else {
                    attributesContainer.innerHTML = '<p style="color: var(--text-color-light);">Selecione um Tipo de Produto para ver atributos.</p>';
                    iaSuggestionsList.innerHTML = '<li style="color: var(--text-color-light);">Selecione um tipo para sugest√µes.</li>';
                }
                 // Adicionar atributos manuais que j√° existiam no produto e n√£o est√£o no template
                if (existingAttributes) {
                    Object.keys(existingAttributes).forEach(key => {
                         // Verifica se o atributo j√° foi renderizado pelo template (comparando por nome ou ID)
                        const isTemplateAttribute = typeTemplate && typeTemplate.attributes.some(attrTmpl => attrTmpl.name === key || attrTmpl.id === key);
                        if (!isTemplateAttribute) {
                             const manualAttrId = `manual_loaded_${key.replace(/\s|\(|\)/g, '_')}`; // Garante ID √∫nico
                             const item = createAttributeItemHTML(manualAttrId, {name:key, type:'text', placeholder:'Valor', required: false}, existingAttributes[key], false);
                             attributesContainer.appendChild(item);
                        }
                    });
                }
                loadingIndicator.classList.add('hidden');
                validateAllProductFields();
            }, 300);
        }
        function createAttributeItemHTML(idSuffix, attrConfig, value, isTemplateField = false) {
            const attrDiv = document.createElement('div');
            attrDiv.className = `attribute-item ${isTemplateField ? 'from-template' : 'manual-add'}`;
            attrDiv.id = `attr-item-${idSuffix}`; 
            let inputHtml = '';
            const inputId = `attr-val-${idSuffix}`;
            const keyInputId = `attr-key-${idSuffix}`;
            const valToSet = value !== null && value !== undefined ? value : (isTemplateField ? (attrConfig.defaultValue || '') : '');
            const isKeyEditable = !isTemplateField;
            const fieldDisplayName = isTemplateField ? attrConfig.name : 'Nome do Atributo Manual';
            // Ajustar as regras de valida√ß√£o para serem passadas corretamente para debouncedValidateField
            const validationConfigValue = { required: (isTemplateField && attrConfig.required), type: attrConfig.type, min: attrConfig.min, max: attrConfig.max, minLength: attrConfig.minLength };
            const validationRulesString = JSON.stringify(validationConfigValue).replace(/"/g, "'"); // Aspas simples para HTML

            if (attrConfig.type === 'select') {
                const optionsHtml = (attrConfig.options || []).map(opt => `<option value="${String(opt).toLowerCase().replace(/\s/g, '_')}" ${valToSet === String(opt).toLowerCase().replace(/\s/g, '_') ? 'selected' : ''}>${opt}</option>`).join('');
                inputHtml = `<select id="${inputId}" class="${attrConfig.required && isTemplateField ? 'validate-required' : ''}" onchange="debouncedValidateField(this, '${inputId}-error', '${fieldDisplayName} Valor', ${validationRulesString})">${optionsHtml}</select>`;
            } else if (attrConfig.type === 'textarea') {
                inputHtml = `<textarea id="${inputId}" placeholder="${attrConfig.placeholder || ''}" rows="2" class="${attrConfig.required && isTemplateField ? 'validate-required' : ''}" oninput="debouncedValidateField(this, '${inputId}-error', '${fieldDisplayName} Valor', ${validationRulesString})">${valToSet}</textarea>`;
            } else if (attrConfig.type === 'boolean') {
                inputHtml = `<input type="checkbox" id="${inputId}" ${valToSet ? 'checked' : ''} style="width:auto; height:auto; margin-top:5px;" class="${attrConfig.required && isTemplateField ? 'validate-required-checkbox' : ''}" onchange="debouncedValidateField(this, '${inputId}-error', '${fieldDisplayName} Valor', ${validationRulesString})">`;
            } else { 
                inputHtml = `<input type="${attrConfig.type || 'text'}" id="${inputId}" value="${valToSet}" placeholder="${attrConfig.placeholder || ''}" class="${attrConfig.required && isTemplateField ? 'validate-required' : ''}" oninput="debouncedValidateField(this, '${inputId}-error', '${fieldDisplayName} Valor', ${validationRulesString})">`;
            }
            
            attrDiv.innerHTML = `
                <div class="form-group" style="flex: 0 0 220px;">
                    <label for="${keyInputId}">
                        ${isTemplateField ? attrConfig.name : 'Nome do Atributo Manual'}
                        ${(isTemplateField && attrConfig.required) || !isTemplateField ? '<span class="required">*</span>' : ''}
                        ${attrConfig.tooltip ? `<span class="tooltip">?<span class="tooltiptext">${attrConfig.tooltip}</span></span>` : ''}
                    </label>
                    <input type="text" id="${keyInputId}" value="${isTemplateField ? attrConfig.name : ''}" ${isTemplateField ? 'disabled' : ''} class="${isTemplateField ? 'template-attr-key' : 'manual-attr-key key-input validate-required'}" placeholder="${isTemplateField ? '' : 'Nome do Atributo'}" oninput="${isTemplateField ? '' : `debouncedValidateField(this, '${keyInputId}-error', 'Nome do Atributo Manual', {required:true, minLength:2})`}">
                    <span class="error-message" id="${keyInputId}-error"></span>
                </div>
                <div class="form-group">
                    <label for="${inputId}">Valor ${(isTemplateField && attrConfig.required) ? '<span class="required">*</span>' : ''}</label>
                    ${inputHtml}
                    <span class="error-message" id="${inputId}-error"></span>
                </div>
                ${!isTemplateField ? `<div class="actions"><button class="btn-small btn-danger" onclick="this.closest('.attribute-item').remove()">Remover</button></div>` : ''}
            `;
            return attrDiv;
        }
        function addAttributeManually() { /* ... */ }
        function addTitleField(titleText = '') {
            const list = document.getElementById('p-titles-list');
            const div = document.createElement('div');
            div.className = 'form-group';
            div.innerHTML = `<input type="text" value="${titleText}" placeholder="T√≠tulo do produto">`;
            list.appendChild(div);
        }
        function addImageField(url = '', alt = '', isPrincipal = false) {
            const list = document.getElementById('p-images-list');
            const div = document.createElement('div');
            div.className = 'media-item';
            div.innerHTML = `<img class="preview" src="${url || 'https://placehold.co/60x60'}" alt="${alt || ''}">`+
                `<input type="text" value="${url}" placeholder="URL da Imagem">`+
                `<input type="text" value="${alt}" placeholder="Alt">`;
            list.appendChild(div);
        }
        function updateImagePreview(previewId, url){ }
        function setMainImage(selectedItem){ }
        function addVideoField(url = '', titulo = '') {
            const list = document.getElementById('p-videos-list');
            const div = document.createElement('div');
            div.className = 'media-item';
            div.innerHTML = `<input type="url" value="${url}" placeholder="URL do V√≠deo">`+
                `<input type="text" value="${titulo}" placeholder="T√≠tulo do V√≠deo">`;
            list.appendChild(div);
        }
        function simulateAICall(buttonElement, loadingMessage, successMessage, failureMessage, callback) { /* ... */ }
        function generateAITitles(btn) { /* ... */ }
        function generateAIDescription(btn) { /* ... */ }
        function fetchIASuggestedValues(btn) { /* ... */ }
        function applyIASuggestion(attributeIdSuffix, attributeName, isNewManual = false) { /* ... */ }
        function applyAIDescription(){ /* ... */ }
        const validationRules = { minLength: (value, length) => String(value).length >= length, maxLength: (value, length) => String(value).length <= length, isNumber: value => !isNaN(parseFloat(value)) && isFinite(value), min: (value, minValue) => parseFloat(value) >= minValue, max: (value, maxValue) => parseFloat(value) <= maxValue, isUrl: value => { try { new URL(value); return true; } catch (e) { return false; } } };
        function debouncedValidateField(fieldElement, errorElementId, fieldName, rules = {}){ clearTimeout(debouncedValidateTimer); debouncedValidateTimer = setTimeout(() => { validateField(fieldElement, errorElementId, fieldName, rules); updateTabErrorIndicators(); }, 400); }
        function validateField(fieldElement, errorElementId, fieldName, rules = {}) { /* (como na v7.1) */ }
        function updateTabErrorIndicators() { /* (como na v7.1) */ }
        function validateAllProductFields() { /* (como na v7.1) */ }
        function saveProduct(isDraft = false, buttonElement = null) { /* (como na v7.1) */ }
        function saveProductAndNew(btn){ /* (como na v7.1) */ }

        // --- L√ìGICA DA P√ÅGINA DE GERENCIAR TIPOS DE PRODUTO ---
        function loadProductTypesList() { /* (como na v7.1) */ }
        function cloneSelectedProductType(){ /* (como na v7.1) */ }
        function openNewProductTypeDefinitionModal() { /* (como na v7.1) */ }
        function selectProductTypeForAdmin(typeKey) { /* (como na v7.1) */ }
        function reorderAttributeTemplateItem(typeKey, attrId, direction){ /* (como na v7.1) */ }
        function openAttributeTemplateModal(attrId = null) { /* (como na v7.1) */ }
        function toggleAttributeOptionsInput(typeValue, optionsGroupId, optionsInputId){ /* (como na v7.1) */ }
        function confirmSaveAttributeToTemplate(buttonElement) { /* (como na v7.1) */ }
        function removeAttributeFromTemplate(typeKey, attrIdToRemove){ /* (como na v7.1) */ }
        
        // --- INICIALIZA√á√ÉO ---
        document.addEventListener('DOMContentLoaded', () => {
            showView('view-produtos');
            populateProductTypeSelector();
            loadProductTypesList();
            handleProductTypeChange('');
            applyProductTableFilters(); // Para popular e filtrar a tabela inicialmente
        });

    </script>
</body>
</html>